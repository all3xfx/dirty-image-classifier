{% extends "base.html" %}
{% load staticfiles %}

{% block content %}

<div class="jumbotron text-center">
  <div class="container">
    
      <img src="{% static 'lang-logo.png'%}" width="300">
    <h1>Is It Porn?</h1>
    <p >This is a (NSFW) demonstration of a  porn detection algorithm. <br/> Upload an image to test the API! </p>
    <p> 
      <img id="preview" src="#" style="display:none;" />
    </p>
    <p> 
      <div style="display:none;" id="porn">
        <h3> Result: <span class="label label-pill label-danger">PORN</span> </h3>  
      </div>
      <div style="display:none;" id="not-porn">
        <h3> Result: <span class="label label-pill label-success">NOT PORN</span></h3>
      </div>
    </p>
    <p>    
        
        <span class="btn btn-default btn-file" >
            
              {% csrf_token %}
              Upload a file <input type="file">

              <div class="progress progress-striped active">
                <div class="bar" style="width: 0%;"></div>
              </div>
              
              <div id="status"></div>

          </span>          
    </p>
    <a type="button" class="btn btn-lg btn-default" href="https://devcenter.heroku.com/articles/getting-started-with-python"><span class="glyphicon glyphicon-flash"></span> Use a sample image</a>
    <a type="button" class="btn btn-lg btn-primary" href="https://github.com/heroku/python-getting-started"><span class="glyphicon glyphicon-download"></span> Source on GitHub</a>
  </div>
</div>
<div class="container">
  <hr>
  <div class="row">
    <div class="col-md-4">
      <h3><span class="glyphicon glyphicon-info-sign"></span> How the algorithm works</h3>
      <p>The algorithm uses an implementation of a convolutional neural network.</p>
    <ul>
        <li>Convolutional neural nets are a common pre-processing step in a neural network</li>
            <img src="{% static 'conv-net.png'%}" width=300>
        <li>They have excellent properties such as translational invariance through a technique called pooling and heirarchical features which make them an excellent choice for image classification problems</li>
        <li>I trained my model on data collected from the Bing Image Search API</li>
        <li>I used the nolearn library, which is built on top of the lasagne library, which is in turn built on top of the theano library.</li>
      </ul>
    </div>
    <div class="col-md-4">
      <h3><span class="glyphicon glyphicon-th"></span> CNN Architecture</h3>
      <pre>
Layer #  name        size
-------  ----------  --------
  0      input0      3x64x64
  1      conv2d1     32x56x56
  2      conv2d2     32x52x52
  3      maxpool2d3  32x26x26
  4      conv2d4     32x22x22
  5      conv2d5     32x20x20
  6      maxpool2d6  32x10x10
  7      dense7      256
  8      dropout8    256
  9      dense9      256
 10      dense10     2
</pre>
    </div>
    <div class="col-md-4">
      <h3><span class="glyphicon glyphicon-link"></span> Libraries Used</h3>
      <ul>
        <li><a href="https://github.com/dnouri/nolearn">nolearn</a></li>
        <li><a href="https://github.com/Lasagne/Lasagne">Lasagne</a></li>
        <li><a href="https://devcenter.heroku.com/articles/getting-started-with-python">Getting Started with Python on Heroku</a></li>
        <li><a href="https://devcenter.heroku.com/articles/django-app-configuration">Configuring Django Apps for Heroku</a></li>
      </ul>
    </div>
  </div> <!-- row -->
</div>

<script>

var sample_urls = "";
function readURL(input) {

    if (input.files && input.files[0]) {
        var reader = new FileReader();

        reader.onload = function (e) {
            $('img#preview').show().attr('src', e.target.result);
        }

        reader.readAsDataURL(input.files[0]);
    }
}

function reset() { $("#not-porn").hide(); $("#porn").hide(); }

$(':file').change(function(){
    reset();
    readURL(this);
    var file = this.files[0];
    name = file.name;
    size = file.size;
    type = file.type;

    var bar = $('.bar');
    bar.width("0");

    if(file.name.length < 1) {
    }
    else if(file.size > 10485760) {
        toastr.error("File is to big");
    }
    else if(file.type != 'image/png' && file.type != 'image/jpg' && file.type != 'image/jpeg' ) {
        toastr.error("File doesnt match png or jpg");
    }
    else { 
        
      var formData = new FormData();
      formData.append('image', file);


      function uploadProgress(event, position, total, percentComplete) {
          var percentVal = percentComplete + '%';
          bar.width(percentVal);
      }

      $.ajax({
          url: 'classify',  //server script to process data
          type: 'POST',
          xhr: function() {  // custom xhr
              myXhr = $.ajaxSettings.xhr();
              if(myXhr.upload){ // if upload property exists
                  myXhr.upload.addEventListener('progress', uploadProgress, false); // progressbar
              }
              return myXhr;
          },
          //Ajax events
          success: completeHandler = function(data) {
              if(data["porn"] === "true") {
                $("#porn").show();
                 $.notifyBar({  html: "That's porn alright. I know it when I see it!"}); 
              } else {
                $("#not-porn").show();
                 $.notifyBar({  html: "I don't think that's porn. At least not the kind of stuff I watch."}); 
                
              }
              // /*
              // * workaround for crome browser // delete the fakepath
              // */
              // if(navigator.userAgent.indexOf('Chrome')) {
              //     var catchFile = $(":file").val().replace(/C:\\*\\/i, '');
              // }
              // else {
              //     var catchFile = $(":file").val();
              // }
              // var writeFile = $(":file");
              // writeFile.html(writer(catchFile));
              // $("*setIdOfImageInHiddenInput*").val(data.logo_id);
          },
          error: errorHandler = function(e) {
              toastr.error("Internal server error");
          },
          // Form data
          data: formData,
          //Options to tell JQuery not to process data or worry about content-type
          cache: false,
          contentType: false,
          processData: false
      }, 'json');
        
    }
});
</script>
{% endblock %}

